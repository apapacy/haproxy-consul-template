# haproxy-consul-template
HAProxy with configuration file generated by consul-template for automatically
update nodes in Consul KV and reload HAProxy when the KV changes.

### Quick start
- Run a Consul instance (server/agent) on current machine
- Run this Docker container:
```
$ docker run -d --net=host --name=haproxy gnhuy91/haproxy-consul-template
```
- Start some test services, note the `rest` tag, this will make Registrator add the tag to Consul:
```
$ docker run -d -P -e SERVICE_TAGS=rest --name=node1 jlordiales/python-micro-service:latest
$ docker run -d -P -e SERVICE_TAGS=rest --name=node2 jlordiales/python-micro-service:latest
$ docker run -d -P -e SERVICE_TAGS=rest --name=node3 jlordiales/python-micro-service:latest
```
- In another teminal, try calling the services via HAProxy:
```
$ while true; do curl <HAProxy IP>:80/python-micro-service/; echo -----; sleep 1; done;
```

You can stop and start those test services (`docker stop node1`) and see the output of above `curl` changes accordingly.

### References
- http://sirile.github.io/2015/05/18/using-haproxy-and-consul-for-dynamic-service-discovery-on-docker.html
- https://github.com/CiscoCloud/haproxy-consul
- https://jlordiales.me/2015/04/01/consul-template/
